{% extends "base.html" %}

{% block title %}Accueil - Smart Classroom{% endblock %}

{% block css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
{% endblock %}

{% block content %}
<!-- Vue d'ensemble du systÃ¨me -->
<div class="system-overview">
    <div class="grid grid-4">
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘¥</div>
            <div class="stat-value" id="studentsPresent">0</div>
            <div class="stat-label">Ã‰tudiants PrÃ©sents</div>
            <div class="status-indicator" id="recognition-status"></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ‘ï¸</div>
            <div class="stat-value" id="attentionRate">0%</div>
            <div class="stat-label">Taux d'Attention</div>
            <div class="status-indicator" id="attention-status"></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ“Š</div>
            <div class="stat-value" id="totalStudents">0</div>
            <div class="stat-label">Total Ã‰tudiants</div>
            <div class="status-indicator" id="database-status"></div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon">ğŸ“¹</div>
            <div class="stat-value">
                <span class="status-text" id="camera-status-text">Inactif</span>
            </div>
            <div class="stat-label">CamÃ©ra</div>
            <div class="status-indicator" id="camera-status"></div>
        </div>
    </div>
</div>

<!-- Actions rapides -->
<div class="quick-actions">
    <h2>ğŸš€ Actions Rapides</h2>
    <div class="grid grid-3">
        <div class="action-card">
            <h3>ğŸ“¸ Capture Rapide</h3>
            <p>Capturer un nouvel Ã©tudiant en quelques clics</p>
            <a href="{{ url_for('capture_page') }}" class="btn btn-success">
                Nouvelle Capture
            </a>
        </div>
        
        <div class="action-card">
            <h3>ğŸ“Š Monitoring</h3>
            <p>Surveiller le systÃ¨me en temps rÃ©el</p>
            <a href="{{ url_for('dashboard_page') }}" class="btn">
                Voir Dashboard
            </a>
        </div>
        
        <div class="action-card">
            <h3>âš™ï¸ ContrÃ´les</h3>
            <p>GÃ©rer la camÃ©ra et les composants</p>
            <button class="btn" onclick="toggleSystemComponent()">
                ContrÃ´ler SystÃ¨me
            </button>
        </div>
    </div>
</div>

<!-- Flux vidÃ©o en direct -->
<div class="video-section">
    <div class="grid grid-2">
        <div class="card">
            <h2>ğŸ“¹ Flux VidÃ©o en Direct</h2>
            <div class="video-container">
                <img id="videoStream" 
                     src="/api/camera/stream" 
                     alt="Flux vidÃ©o Smart Classroom"
                     style="width: 100%; height: 100%; object-fit: cover; border-radius: 10px; display: none;"
                     onload="handleVideoLoad(this)"
                     onerror="handleVideoError(this)">
                <div id="videoPlaceholder" class="video-placeholder">
                    ğŸ¥ Connexion au flux vidÃ©o...<br>
                    <small>VÃ©rifiez que la camÃ©ra est active</small>
                </div>
            </div>
            <div class="video-controls">
                <button class="btn btn-success" onclick="toggleCamera()" id="cameraBtn">
                    DÃ©marrer CamÃ©ra
                </button>
                <button class="btn" onclick="takeSnapshot()">ğŸ“¸ Snapshot</button>
                <button class="btn" onclick="refreshStream()">ğŸ”„ Actualiser</button>
            </div>
        </div>
        
        <!-- Logs rÃ©cents -->
        <div class="card">
            <h2>ğŸ“ ActivitÃ© RÃ©cente</h2>
            <div class="recent-logs" id="recentLogs">
                <div class="log-entry">
                    <span class="log-time">Chargement...</span>
                    <span class="log-message">Initialisation du systÃ¨me</span>
                </div>
            </div>
            <div class="text-center mt-2">
                <a href="{{ url_for('dashboard_page') }}" class="btn btn-secondary">
                    Voir Tous les Logs
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Ã‰tat des composants -->
<div class="components-status">
    <h2>ğŸ”§ Ã‰tat des Composants</h2>
    <div class="grid grid-4">
        <div class="component-card" id="camera-component">
            <div class="component-icon">ğŸ“¹</div>
            <div class="component-name">CamÃ©ra</div>
            <div class="component-status">
                <div class="status-indicator" id="camera-status-comp"></div>
                <span class="status-text">Inactif</span>
            </div>
            <button class="btn btn-sm" onclick="toggleCamera()">Toggle</button>
        </div>
        
        <div class="component-card" id="recognition-component">
            <div class="component-icon">ğŸ¤–</div>
            <div class="component-name">Reconnaissance</div>
            <div class="component-status">
                <div class="status-indicator" id="recognition-status-comp"></div>
                <span class="status-text">Inactif</span>
            </div>
            <button class="btn btn-sm" onclick="toggleRecognition()">Toggle</button>
        </div>
        
        <div class="component-card" id="attention-component">
            <div class="component-icon">ğŸ‘ï¸</div>
            <div class="component-name">Suivi Attention</div>
            <div class="component-status">
                <div class="status-indicator" id="attention-status-comp"></div>
                <span class="status-text">Inactif</span>
            </div>
            <button class="btn btn-sm" onclick="toggleAttention()">Toggle</button>
        </div>
        
        <div class="component-card" id="door-component">
            <div class="component-icon">ğŸšª</div>
            <div class="component-name">ContrÃ´le Porte</div>
            <div class="component-status">
                <div class="status-indicator" id="door-status-comp"></div>
                <span class="status-text">DÃ©connectÃ©</span>
            </div>
            <button class="btn btn-sm" onclick="testDoor()">Test</button>
        </div>
    </div>
</div>
{% endblock %}

{% block javascript %}
<script src="{{ url_for('static', filename='js/camera.js') }}"></script>
<script>
// Code spÃ©cifique Ã  la page d'accueil
document.addEventListener('DOMContentLoaded', function() {
    // Initialiser les composants de la page d'accueil
    initializeHomePage();
    
    // DÃ©marrer la mise Ã  jour des statistiques
    startStatsUpdater();
    
    // Charger l'activitÃ© rÃ©cente
    loadRecentActivity();
    
    // VÃ©rifier le statut initial de la camÃ©ra
    checkInitialCameraStatus();
});

function initializeHomePage() {
    console.log('ğŸ  Initialisation page d\'accueil');
    
    // Charger les statistiques initiales
    updateStats();
    
    // Configuration du stream vidÃ©o
    setupVideoStream();
}

function startStatsUpdater() {
    // Mettre Ã  jour les stats toutes les 5 secondes
    setInterval(updateStats, 5000);
}

async function updateStats() {
    try {
        const response = await api.get('/api/students/stats');
        if (response.success && response.stats) {
            document.getElementById('totalStudents').textContent = response.stats.total_students || 0;
        }
        
        // Simuler d'autres statistiques
        document.getElementById('studentsPresent').textContent = Math.floor(Math.random() * 5);
        document.getElementById('attentionRate').textContent = (Math.floor(Math.random() * 30) + 70) + '%';
        
    } catch (error) {
        console.error('Erreur mise Ã  jour stats:', error);
    }
}

async function loadRecentActivity() {
    try {
        const logs = await api.get('/api/logs/attendance?limit=5');
        const container = document.getElementById('recentLogs');
        
        if (logs.logs && logs.logs.length > 0) {
            container.innerHTML = logs.logs.map(log => `
                <div class="log-entry">
                    <span class="log-time">${Utils.formatDate(log.timestamp)}</span>
                    <span class="log-message">${log.student_name || 'SystÃ¨me'} - ${log.course || 'ActivitÃ©'}</span>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="log-entry">Aucune activitÃ© rÃ©cente</div>';
        }
    } catch (error) {
        console.error('Erreur chargement logs:', error);
    }
}

function checkInitialCameraStatus() {
    // VÃ©rifier le statut de la camÃ©ra au chargement
    setTimeout(async () => {
        try {
            const status = await api.get('/api/camera/status');
            if (status.success && status.active) {
                startVideoStream();
            }
        } catch (error) {
            console.log('CamÃ©ra non disponible au dÃ©marrage');
        }
    }, 1000);
}

// Fonctions de contrÃ´le des composants
async function toggleSystemComponent() {
    // Ouvrir un modal de contrÃ´le ou rediriger vers les paramÃ¨tres
    notifications.info('Fonction de contrÃ´le systÃ¨me - Ã€ implÃ©menter');
}

async function toggleRecognition() {
    try {
        // Alterner entre start et stop selon l'Ã©tat actuel
        const endpoint = systemManager.status.recognition ? '/api/recognition/stop' : '/api/recognition/start';
        const response = await api.post(endpoint);
        
        if (response.success) {
            notifications.success(response.message);
            systemManager.updateSystemStatus();
        } else {
            notifications.error(response.message);
        }
    } catch (error) {
        notifications.error('Erreur contrÃ´le reconnaissance');
    }
}

async function toggleAttention() {
    notifications.info('Suivi d\'attention - ContrÃ´le Ã  implÃ©menter');
}

async function testDoor() {
    try {
        const response = await api.post('/api/door/test');
        if (response.success) {
            notifications.success(response.message);
        } else {
            notifications.error(response.message);
        }
    } catch (error) {
        notifications.error('Erreur test porte');
    }
}
</script>
{% endblock %}